## 概述

*环境是一个高级话题，他是javascript的内部细节，如果你想要深入了解变量如何工作，读这个章节*

当程序执行进入它的作用域时，变量产生了。之后它需要存储空间。在javascript中，提供存储空间的数据结构被称为环境。它映射变量的名称到其值。它的结构和javascript的object类型非常相似。环境有时存活在你离开它的作用域之后。因此，它们是存储在堆上，而不是存储在栈上。

变量有两种方式传递。它们有两个维度，如果你愿意的话：

## 动态维度： 调用函数

每次一个函数被调用，它的参数和变量需要新的存储。它完成之后，存储通常能够被回收。作为一个例子，采取下面的factorial函数的实例。每次递归调用自身好几次，n需要新鲜的存储：

``` javascript
function fac(n) {
    if (n <= 1) {
        return 1;
    }
    return n * fac(n - 1);
}
```

## 词法(静态)维度： 和你的周围作用域保持连接

无论多久调用一个函数，它总是需要访问到自己的本地变量和周围作用域的变量。例如，下面的函数doNTimes，有一个函数助手doNTimesRec，在它的内部。当doNTimesRec调用自身几次，每次会创建一个新环境。但是，这些调用期间，doNTimesRec还与doNTimes单一环境保持连接。类似于所有函数共享一个单独全局环境。doNTimesRec需要访问action的链接。

```javascript
function doNTimes(n, action) {
    function doNTimesRec(x) {
        if (x >= 1) {
            action();  // (1)
            doNTimesRec(x-1);
        }
    }
    doNTimesRec(n);
}
```

这两个维度像下面一样被处理:

## 动态维度：执行栈上下文

每次一个函数被调用，一个新的环境被创建来映射标识符（参数和变量）到值。对于递归的处理，执行上下文-引用环境-在栈中被管理。镜像调用堆栈。

## 词法维度：环境链

为了支持这个维度，一个函数通过内部[[scope]]属性创建记录作用域。当一个函数被调用时，一个环境被创建给被进入的新作用域。环境有一个被叫做outer的字段，它指向外部的作用域的环境，并且通过[[scope]]安装。因此，总是有一个环境链，从当前活跃环境为开始，继续它的外部环境，等等。每个链的最后都是全局环境。（所有初始化调用函数的作用域）。全局环境的outer字段是null。

为了解析一个标识符，完整的环境链被遍历，从当前活跃环境开始。

让我们来看一个例子：

```javascript
function myFunction(myParam) {
    var myVar = 123;
    return myFloat;
}
var myFloat = 1.3;
// Step 1
myFunction('abc');  // Step 2
```

说明当前面的代码被执行时发生了什么：

1. myFunction和myFloat已经被存储在全局环境中。注意，函数对象，被通过内部属性[[scope]]指向它的作用域的myFunction引用。
2. myFunction函数的执行，一个新环境被创建来保存参数和本地变量。它通过outer引用它的outer环境（从myFunction[[scope]]）中被初始化。感谢outer变量，myFunction能访问myFloat.